<!DOCTYPE html>
<html>
<head>
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–ª–æ–≥–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        #editor-container {
            height: 400px;
            margin: 20px 0;
        }
        .post-list {
            max-width: 800px;
            margin: 2rem auto;
        }
        .post-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="post-list" id="postList"></div>
    
    <div class="editor">
        <button onclick="newPost()">–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è</button>
        <input type="text" id="postId" hidden>
        <input type="text" id="postTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
        <input type="text" id="postCategory" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">
        <div id="editor-container"></div>
        <input type="file" id="postImage" accept="image/*">
        <button onclick="savePost()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div id="preview"></div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Quill Editor -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const quill = new Quill('#editor-container', {
            modules: { toolbar: [
                ['bold', 'italic', 'underline'],
                ['image', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]},
            theme: 'snow'
        });

        let posts = [];

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∞—Ç–µ–π
        async function loadPosts() {
            const response = await fetch('/blog/posts.json');
            posts = await response.json();
            renderPostList();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç–µ–π
        function renderPostList() {
            const list = document.getElementById('postList');
            list.innerHTML = posts.map(post => `
                <div class="post-item">
                    <span>${post.title}</span>
                    <div>
                        <button onclick="editPost('${post.id}')">‚úé</button>
                        <button onclick="deletePost('${post.id}')">üóë</button>
                    </div>
                </div>
            `).join('');
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
        async function editPost(id) {
            const post = posts.find(p => p.id === id);
            const response = await fetch(post.contentPath);
            const content = await response.text();
            
            document.getElementById('postId').value = id;
            document.getElementById('postTitle').value = post.title;
            document.getElementById('postCategory').value = post.category;
            quill.root.innerHTML = content;
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
        async function deletePost(id) {
            posts = posts.filter(p => p.id !== id);
            await savePosts();
            loadPosts();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π
        async function savePost() {
            const post = {
                id: document.getElementById('postId').value || Date.now().toString(),
                title: document.getElementById('postTitle').value,
                category: document.getElementById('postCategory').value,
                date: new Date().toISOString(),
                content: quill.root.innerHTML,
                image: await handleImageUpload()
            };

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ JSON
            if(!posts.find(p => p.id === post.id)) {
                posts.push(post);
            }
            
            await savePosts();
            await generateHtml(post);
            loadPosts();
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
        async function generateHtml(post) {
            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${post.title}</title>
                    <!-- –°—Ç–∏–ª–∏ —Å–∞–π—Ç–∞ -->
                </head>
                <body>
                    ${post.content}
                </body>
                </html>
            `;

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            const filename = `post_${post.id}.html`;
            await fetch('/save-article', {
                method: 'POST',
                body: JSON.stringify({filename, content: html})
            });
        }

        loadPosts();
    </script>
</body>
</html>